<!doctype>
<html ng-app='sleth'>
<head>
<script type="text/javascript" src="lib/angular.min.js"></script>
<script type="text/javascript" src="lib/promise.min.js"></script>
<script type="text/javascript" src="lib/bignumber.min.js"></script>
<script type="text/javascript" src="lib/ethereum.js"></script>
</head>
<body>
<h1>sleth</h1>

<div ng-controller="SlethController">
    <div>
        Contract: {{slethAddress}}<br />
        Player: {{player.address}}<br />
        Balance: {{player.balance | number : 4}} ETH<br />
        Coins: {{player.coins}}<br />
    </div>

    <div>
        <button ng-click="deposit(depositAmount)">deposit</button>
        <input type="number" ng-model="depositAmount" value="0" integer min="0"></input> coins
    </div>
    <div>
        <button ng-click="withdraw(withdrawAmount)" ng-disabled="player.coins == 0">withdraw</button>
        <input type="number" ng-model="withdrawAmount" value="0" integer min="0"></input> coins
    </div>

    <hr />
    <div>
        <h3>Round #{{round.number}}</h3>
        <div>Player: {{round.player}}</div>
        <div>Block: {{round.block}}</div>
        <div>Timestamp: {{round.timestamp | date : 'medium'}}</div>
        <div>Bet: {{round.bet}}</div>
        <div ng-if="round.status == 2">Result: {{round.result}}</div>
        <div ng-if="round.status == 2">Entropy: {{round.entropy}}</div>
        <div>Status:
            <span ng-switch on="round.status">
                <span ng-switch-when="0">new</span>
                <span ng-switch-when="1">spinning</span>
                <span ng-switch-when="2">done</span>
            </span>
        </div>
    </div>
    <hr />
    <div>
        <button type="button" ng-click="spin(1)" ng-disabled="player.coins < 1">spin 1</button>
        <button type="button" ng-click="spin(3)" ng-disabled="player.coins < 3">spin 3</button>
        <button type="button" ng-click="spin(5)" ng-disabled="player.coins < 5">spin 5</button>
    </div>
    <div>
        <button type="button" ng-click="claim(player.round, entropy)">claim</button>
        round
        <input type="number" ng-model="player.round" integer min="1"></input>
        entropy
        <input type="number" ng-model="entropy" integer min="0" max="32767"></input>
    </div>
    <hr />
    <div>
        <h3>Message:</h3>
        {{message}}
    </div>
</div>
<script>
var app = angular.module('sleth',[]);
app.factory('web3', function() {
    var web3 = require('web3');
    web3.setProvider(new web3.providers.AutoProvider());
    return web3;
});

app.controller("SlethController", ['$http', '$q', '$scope', 'web3', function($http, $q, $scope, web3) {


    $scope.slethAddress = "0x23a2df087d6ade86338d6cf881da0f12f6b9257a";
    $scope.contract = $q.defer();

    $scope.player = {};
    $scope.round = {};
    $scope.message = "";

    $http.get('../contracts/sleth.abi.json').then(function(res) {
        $scope.contract.resolve(web3.eth.contract($scope.slethAddress, res.data));
    });

    $scope.updateAccount = function() {
        web3.eth.accounts.then(function (accounts) {
            $scope.player.address = accounts[0];
            $scope.$apply();
            return(web3.eth.balanceAt(accounts[0]));
        }).then(function (balance) {
            $scope.player.balance = web3.toDecimal(balance) / Math.pow(10, 18);
            $scope.$apply();
        });
    };

    $scope.updatePlayer = function() {
        $scope.contract.promise.then(function(contract) {
            return(contract.get_current_player().call());
        }).then(function(res) {
            $scope.player.round = res[0].toNumber();
            $scope.player.coins = res[1].toNumber();
        });
    };

    $scope.updateRound = function() {
        var roundNumber = $scope.player.round;
        if(roundNumber) {
            $scope.contract.promise.then(function(contract) {
                return(contract.get_round(roundNumber).call());
            }).then(function(res) {
                console.log("ROUND", res);
                var round = {
                    number: roundNumber,
                    player: res[0],
                    block: res[1].toNumber(),
                    timestamp: new Date(res[2].toNumber() * 1000),
                    bet: res[3].toNumber(),
                    result: res[4].toNumber(),
                    entropy: res[5].toNumber(),
                    status: res[6].toNumber()
                };
                $scope.round = round;

                if (round.status == 2) {
                    $scope.message = "Results for round #" + roundNumber + ": you won ";
                    if (round.result) {
                        $scope.message += round.result + " coins :)";
                    } else {
                        $scope.message += "nothing :(";
                    };

                }
            });
        }
    };

    $scope.deposit = function(amount) {
        console.log("DEPOSIT", amount);
        if (amount) {
            var value = web3.fromDecimal(amount * Math.pow(10, 18));

            $scope.contract.promise.then(function(contract) {
                return(contract.deposit().transact({value: value}));
            }).then(function(res) {
                $scope.message = "Deposited " + amount;
                $scope.updateAccount();
                $scope.updatePlayer();
            });
        }
    };

    $scope.withdraw = function(amount) {
        console.log("WITHDRAW", amount);

        if (amount) {
            $scope.contract.promise.then(function(contract) {
                return(contract.withdraw(amount).transact());
            }).then(function(res) {
                $scope.message = "Withdrawn " + amount;
                $scope.updateAccount();
                $scope.updatePlayer();
            });
        }
    };

    $scope.spin = function(bet) {
        if (bet) {
            $scope.contract.promise.then(function(contract) {
                return(contract.spin(bet).transact());
            }).then(function(res) {
                $scope.message = "Spinning... " + bet;
                $scope.updatePlayer();
            });

            $scope.generateEntropy();
        }
    }

    $scope.claim = function(round, entropy) {
        if (round) {
            $scope.contract.promise.then(function(contract) {
                return(contract.claim(round, entropy).transact());
            }).then(function(res) {
                $scope.message = "Claiming... " + round;
                $scope.updatePlayer();
                $scope.updateRound();
            });
        }
    }

    $scope.generateEntropy = function() {
        $scope.entropy = Math.floor(Math.random() * Math.pow(32, 3));
    };

    $scope.$watch('player.round', $scope.updateRound);

    web3.eth.watch('chain').changed(function(res) {
        console.log("CHAIN UPDATED", res);
        $scope.updateAccount();
        $scope.updatePlayer();
        $scope.updateRound();
    });

    $scope.updateAccount();
    $scope.updatePlayer();
    $scope.generateEntropy();
}]);
</script>
</body>
</html>
